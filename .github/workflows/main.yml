name: Build "turnip"

on:
  workflow_dispatch:
  schedule:
    - cron: "20 5 1,15 * *"

jobs:
  start_building_turnip:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v3

      - name: Install required packages
        run: |
          sudo apt update
          sudo apt install python3-pip ninja-build curl unzip patchelf flex bison zip -y
          pip install --upgrade meson mako

          # ðŸ”§ Install glslang binaries
          wget https://github.com/KhronosGroup/glslang/releases/download/11.13.0/glslang-master-linux-Release.zip
          unzip glslang-master-linux-Release.zip -d glslang-bin
          sudo mv glslang-bin/bin/* /usr/local/bin/
          
      - name: Execute build script
        run: |
          chmod +x ./turnip_builder.sh
          bash ./turnip_builder.sh

      - name: Upload logs even if build fails
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: meson-ninja-logs
          path: |
            turnip_workdir/ninja_log
            turnip_workdir/mesa-main/build-android-aarch64/meson-logs/meson-log.txt

      - name: Release "turnip"
        if: success()
        uses: softprops/action-gh-release@v1
        with:
          body: Turnip magisk module and driver package for adrenotools
          tag_name: github_run
          name: Weekly Action Release
          files: |
            turnip_workdir/turnip.zip
            turnip_workdir/turnip_adrenotools.zip
