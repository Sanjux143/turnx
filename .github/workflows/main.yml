name: Build "turnip"

on:
  workflow_dispatch:
  schedule:
    - cron: "20 5 1,15 * *"

permissions:
  contents: write

jobs:
  start_building_turnip:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Prepare environment
        run: |
          sudo sed -i 's/^Types: deb$/Types: deb deb-src/' /etc/apt/sources.list.d/ubuntu.sources || true
          sudo apt update
          sudo apt install -y software-properties-common
          sudo apt build-dep mesa -y || true
          sudo apt install -y \
            ninja-build \
            unzip \
            curl \
            zip \
            bison \
            flex \
            glslang-tools \
            python3-pip \
            cmake \
            git

          # ✅ Install latest Meson via PIP (>= 1.4.0)
          pip install --upgrade pip
          pip install meson mako

          # 🔁 glslang fallback
          if ! command -v glslang >/dev/null; then
            echo "glslang not found, linking glslangValidator as fallback..."
            if command -v glslangValidator >/dev/null; then
              sudo ln -s $(which glslangValidator) /usr/local/bin/glslang
            else
              echo "glslangValidator also missing!"
              exit 1
            fi
          fi

      - name: Execute build script
        run: bash ./turnip_builder.sh

      - name: Upload logs even if build fails
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: meson-ninja-logs
          path: |
            turnip_workdir/ninja_log
            turnip_workdir/mesa-main/build-android-aarch64/meson-logs/meson-log.txt

      - name: Release "turnip"
        if: success()
        uses: softprops/action-gh-release@v1
        with:
          body: Turnip magisk module and driver package for adrenotools
          tag_name: github_run
          name: Weekly Action Release
          files: |
            turnip_workdir/turnip.zip
            turnip_workdir/turnip_adrenotools.zip
